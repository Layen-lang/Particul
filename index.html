<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<title>Particules 3D iPhone</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  html,body { height:100%; margin:0; background:#111; color:#eee; font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;}
  #container { width:100%; height:100vh; display:block; overflow:hidden; }
</style>
</head>
<body>
<div id="container"></div>

<script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.158.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://unpkg.com/lil-gui@0.18.0/dist/lil-gui.min.js"></script>
<script>
/* Version allégée pour iOS */
const container = document.getElementById('container');
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0a0a0a);

const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 5000);
camera.position.set(0, 40, 150);

const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Évite trop de charge GPU
container.appendChild(renderer.domElement);

const controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;

// Sprite simple
function generateSprite(){
  const c = document.createElement('canvas');
  c.width = c.height = 64;
  const ctx = c.getContext('2d');
  const grad = ctx.createRadialGradient(32, 32, 0, 32, 32, 32);
  grad.addColorStop(0, '#fff');
  grad.addColorStop(1, 'rgba(0,0,0,0)');
  ctx.fillStyle = grad;
  ctx.fillRect(0,0,64,64);
  return c;
}

// Géométrie
const maxParticles = 8000; // Limité pour iPhone
const positions = new Float32Array(maxParticles * 3);
for (let i=0; i<maxParticles; i++) {
  positions[i*3] = (Math.random() - 0.5) * 100;
  positions[i*3+1] = (Math.random() - 0.5) * 100;
  positions[i*3+2] = (Math.random() - 0.5) * 100;
}
const geometry = new THREE.BufferGeometry();
geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));

const texture = new THREE.CanvasTexture(generateSprite());
const material = new THREE.PointsMaterial({
  size: 5,
  map: texture,
  transparent: true,
  blending: THREE.AdditiveBlending,
  depthWrite: false
});

const particles = new THREE.Points(geometry, material);
scene.add(particles);

// Animation
function animate(){
  requestAnimationFrame(animate);
  particles.rotation.y += 0.002;
  controls.update();
  renderer.render(scene, camera);
}
animate();

// Redimensionnement
window.addEventListener('resize', ()=>{
  camera.aspect = window.innerWidth/window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
});

// Gestion WebGL context perdu (iOS)
renderer.domElement.addEventListener('webglcontextlost', (e)=>{
  e.preventDefault();
  alert('Contexte WebGL perdu. Rechargez la page.');
});
</script>
</body>
</html>
